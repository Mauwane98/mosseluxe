{% extends 'base.html' %}

{% block content %}
<div class="container my-5 bg-white-section rounded shadow-sm">
    <h1 class="mb-4 text-center" style="font-family: 'Playfair Display', serif;">Checkout</h1>
    
    {% if checkout_error %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ checkout_error }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}

    {% if cart_item_count == 0 or cart_products_details is empty %}
        <div class="text-center py-5">
            <p class="text-muted">Your shopping cart is empty. Please add items before checking out.</p>
            <a href="/shop" class="btn btn-lg btn-outline-dark-alt mt-3">Start Shopping</a>
        </div>
    {% else %}
    <div class="row">
        <!-- Shipping Details Form -->
        <div class="col-lg-7">
            <h3 class="mb-3">Shipping Information</h3>
            <form action="/checkout" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="firstName" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="firstName" name="firstName" required value="{{ post.firstName ?? '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="lastName" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="lastName" name="lastName" required value="{{ post.lastName ?? '' }}">
                    </div>
                    <div class="col-12">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="email" name="email" placeholder="you@example.com" required value="{{ post.email ?? '' }}">
                    </div>
                    <div class="col-12">
                        <label for="address" class="form-label">Address</label>
                        <input type="text" class="form-control" id="address" name="address" placeholder="1234 Main St" required value="{{ post.address ?? '' }}">
                    </div>
                    <div class="col-12">
                        <label for="address2" class="form-label">Address 2 <span class="text-muted">(Optional)</span></label>
                        <input type="text" class="form-control" id="address2" name="address2" placeholder="Apartment or suite" value="{{ post.address2 ?? '' }}">
                    </div>
                    <div class="col-md-5">
                        <label for="city" class="form-label">City</label>
                        <input type="text" class="form-control" id="city" name="city" required value="{{ post.city ?? '' }}">
                    </div>
                    <div class="col-md-4">
                        <label for="province" class="form-label">Province</label>
                        <select class="form-select" id="province" name="province" required>
                            <option value="">Choose...</option>
                            <option value="Gauteng" {% if post.province ?? '' == 'Gauteng' %}selected{% endif %}>Gauteng</option>
                            <option value="Western Cape" {% if post.province ?? '' == 'Western Cape' %}selected{% endif %}>Western Cape</option>
                            <option value="KwaZulu-Natal" {% if post.province ?? '' == 'KwaZulu-Natal' %}selected{% endif %}>KwaZulu-Natal</option>
                            <option value="Eastern Cape" {% if post.province ?? '' == 'Eastern Cape' %}selected{% endif %}>Eastern Cape</option>
                            <option value="Free State" {% if post.province ?? '' == 'Free State' %}selected{% endif %}>Free State</option>
                            <option value="Limpopo" {% if post.province ?? '' == 'Limpopo' %}selected{% endif %}>Limpopo</option>
                            <option value="Mpumalanga" {% if post.province ?? '' == 'Mpumalanga' %}selected{% endif %}>Mpumalanga</option>
                            <option value="North West" {% if post.province ?? '' == 'North West' %}selected{% endif %}>North West</option>
                            <option value="Northern Cape" {% if post.province ?? '' == 'Northern Cape' %}selected{% endif %}>Northern Cape</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="zip" class="form-label">Postal Code</label>
                        <input type="text" class="form-control" id="zip" name="zip" required value="{{ post.zip ?? '' }}">
                    </div>
                </div>

                <hr class="my-4">

                <h3 class="mb-3">Payment Method</h3>
                <div class="my-3">
                    <div class="form-check">
                        <input id="payfast" name="paymentMethod" type="radio" class="form-check-input" value="PayFast" {% if post.paymentMethod ?? '' == 'PayFast' %}checked{% endif %} required>
                        <label class="form-check-label" for="payfast">PayFast (Credit/Debit Card)</label>
                    </div>
                    <div class="form-check">
                        <input id="eft" name="paymentMethod" type="radio" class="form-check-input" value="Manual EFT" {% if post.paymentMethod ?? '' == 'Manual EFT' %}checked{% endif %} required>
                        <label class="form-check-label" for="eft">Manual EFT</label>
                    </div>
                </div>

                <hr class="my-4">
                
                <!-- Place Order Button -->
                <div class="d-grid"> 
                    <button type="submit" class="btn btn-lg btn-primary-dark w-100">Place Order</button>
                </div>

            </form>
        </div>

        <!-- Order Summary -->
        <div class="col-lg-5 mt-5 mt-lg-0">
            <div class="card border">
                <div class="card-body">
                    <h4 class="d-flex justify-content-between align-items-center mb-3">
                        <span>Your Order</span>
                        <span class="badge bg-secondary rounded-pill">{{ cart_item_count }}</span>
                    </h4>
                    <ul class="list-group list-group-flush">
                        {% for product_id, item in session.cart %}
                            {% if cart_products_details[product_id] is defined %}
                                {% set product_detail = cart_products_details[product_id] %}
                                {% set price_to_use_display = (product_detail.sale_price is not empty and product_detail.sale_price > 0) ? product_detail.sale_price : product_detail.price %}
                                {% set item_total = price_to_use_display * item.quantity %}
                                <li class="list-group-item d-flex justify-content-between lh-sm">
                                    <div>
                                        <h6 class="my-0">{{ product_detail.name }}</h6>
                                        <small class="text-muted">Qty: {{ item.quantity }}</small>
                                    </div>
                                    <span class="text-muted">R {{ "%.2f"|format(item_total) }}</span>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Subtotal</span>
                            <strong id="summary-subtotal">R {{ "%.2f"|format(total_cart_price_display) }}</strong>
                        </li>
                         <li class="list-group-item d-flex justify-content-between">
                            <span>Shipping</span>
                            <strong>R {{ "%.2f"|format(shipping_cost) }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between text-success" id="summary-discount-row" style="display: none;">
                            <span>Discount</span>
                            <strong id="summary-discount-amount"></strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between fw-bold">
                            <strong>Total (ZAR)</strong>
                            <strong>R {{ "%.2f"|format(total_cart_price_display + shipping_cost) }}</strong>
                        </li>
                    </ul>
                    <!-- The 'Place Order' button is now part of the form -->
                    <div class="p-2 mt-3">
                        <div class="input-group"> 
                            <input type="text" class="form-control" placeholder="Discount code" id="discount-code-input"> 
                            <button class="btn btn-outline-secondary" type="button" id="apply-discount-btn">Apply</button> 
                        </div> 
                        <div id="discount-message" class="mt-2 small"></div>
                    </div>
                </div>
            </div>
             <div class="text-center mt-3">
                <a href="/cart" class="text-dark">&leftarrow; Back to Cart</a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const applyBtn = document.getElementById('apply-discount-btn');
    const discountInput = document.getElementById('discount-code-input');
    const discountMessage = document.getElementById('discount-message');
    const csrfToken = '{{ csrf_token }}';

    applyBtn.addEventListener('click', function() {
        const code = discountInput.value.trim();
        if (!code) {
            discountMessage.textContent = 'Please enter a code.';
            discountMessage.className = 'mt-2 small text-warning';
            return;
        }

        discountMessage.textContent = 'Applying...';
        discountMessage.className = 'mt-2 small text-muted';

        const formData = new FormData();
        formData.append('discount_code', code);
        formData.append('csrf_token', csrfToken);

        fetch('/apply-discount', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            discountMessage.textContent = data.message;
            if (data.success) {
                discountMessage.className = 'mt-2 small text-success';
                document.getElementById('summary-discount-row').style.display = 'flex';
                document.getElementById('summary-discount-amount').textContent = `- ${data.discount_amount_formatted}`;
                // Update the final total
                // This part needs to be updated to target the correct element for total
                // For now, let's just reload the page to reflect changes
                window.location.reload();
            } else {
                discountMessage.className = 'mt-2 small text-danger';
            }
        })
        .catch(error => {
            discountMessage.textContent = 'An error occurred.';
            discountMessage.className = 'mt-2 small text-danger';
        });
    });
});
</script>
{% endblock %}
